<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>Identicon Generator</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="/js/tailwind.config.js"></script>
  <link rel="stylesheet" href="/css/custom.css">
</head>
<body class="bg-[#1a1a2e] text-[#e0e0e0] flex justify-center items-start min-h-screen p-10 bg-[radial-gradient(circle_at_15%_50%,#16223b,transparent_40%)] bg-[radial-gradient(circle_at_85%_30%,#2e1a47,transparent_40%)]">
<div class="container0">
  <div class="main-wrapper w-full max-w-4xl flex gap-8">
    <div class="container flex-[2] text-center p-10 rounded-2xl bg-white/10 backdrop-blur-md border border-white/20 shadow-2xl shadow-black/40">
      <h1 class="text-4xl font-bold mb-2 bg-gradient-to-r from-teal-300 to-blue-500 text-transparent bg-clip-text">Identicon Generator</h1>
      <p class="text-gray-400 text-lg">당신만의 고유한 아이덴티티를 생성해보세요.</p>
      <form id="generate-form" class="flex gap-3 my-8">
        <input id="text-input" type="text" name="text" placeholder="영문, 숫자, 한글 모두 가능"
               class="flex-grow p-4 text-base rounded-lg bg-black/20 border border-white/20 text-white placeholder-gray-500 transition duration-300">
        <button type="submit" id="generate-button"
                class="gradient-btn ripple-btn px-6 py-4 text-base font-bold rounded-lg
                               text-[#1a1a2e]
                               hover:-translate-y-0.5 hover:shadow-lg
                               transition-all duration-300">
          <span class="relative z-10">GENERATE</span>
        </button>
      </form>
      <div id="result-area" class="mt-8 p-5 rounded-xl bg-black/20" style="display: none;">
        <h2 class="text-xl font-bold">Generated Icon</h2>
        <p class="text-gray-400">Input Text: <b id="result-text" class="text-white"></b></p>
        <img id="result-image" src="" alt="Generated Identicon" class="mt-4 rounded-lg shadow-lg mx-auto">
      </div>
    </div>
    <div id="history-panel" class="flex-1 p-8 rounded-2xl bg-white/10 backdrop-blur-md border border-white/20 shadow-2xl shadow-black/40 h-fit">
      <h3 class="text-center text-xl font-bold border-b border-white/20 pb-3 mb-4">History</h3>
      <ol id="history-list" class="list-none p-0"></ol>
    </div>
  </div>
  <div id="toast-notification"></div>
</div>
<script>
  function showToast(message) {
    const toast = $('#toast-notification');
    toast.text(message).addClass('show');
    setTimeout(function() {
      toast.removeClass('show');
    }, 3000);
  }

  function updateHistoryView() {
    const historyList = $('#history-list');
    historyList.empty();
    requestHistory.forEach(item => {
      const li = $('<li></li>')
              .text(item)
              .addClass('p-3 mb-2 rounded-lg bg-black/20 cursor-pointer hover:bg-blue-500 hover:text-white transition-colors duration-300 break-all')
              .data('text', item);
      historyList.append(li);
    });
  }

  let requestHistory = []; // 요청 기록을 저장할 배열
  const MAX_HISTORY_SIZE = 10; // 10개까지 기록

  $(function() {
    const savedHistory = localStorage.getItem('identiconHistory');
    if (savedHistory) {
      requestHistory = JSON.parse(savedHistory);
      updateHistoryView();
    }

    $('#generate-form').on('submit', function(event) {
      event.preventDefault();
      const textValue = $('#text-input').val().trim();
      if (textValue === '') {
        $('#text-input').addClass('border-red-500 animate-shake').delay(500).queue(function() {
          $(this).removeClass('border-red-500 animate-shake').dequeue();
        });
        return;
      }

      const encodedText = encodeURIComponent(textValue);
      const imageUrl = '/generate/' + encodedText;

      $.ajax({ url: imageUrl, method: 'GET', xhrFields: { responseType: 'blob' } })
              .done(function(data) {
                // 받은 blob 데이터를 이미지 URL로 변환 // 브라우저 캐시에 저장됨
                const blobUrl = (window.URL || window.webkitURL).createObjectURL(data);
                $('#result-text').text(textValue);
                $('#result-image').attr('src', blobUrl);
                $('#result-area').fadeIn();

                // 배열의 맨 앞에 새로운 요청을 추가
                requestHistory.unshift(textValue);
                // Set을 이용해 중복된 항목을 제거하고 다시 배열로 만듦
                requestHistory = [...new Set(requestHistory)];
                // 최대 기록 개수 유지
                if (requestHistory.length > MAX_HISTORY_SIZE) {
                  requestHistory.pop(); // 가장 오래된 항목 제거
                }
                // 브라우저에 기록 저장
                localStorage.setItem('identiconHistory', JSON.stringify(requestHistory));
                updateHistoryView();

              }).fail(function() { showToast("이미지 생성에 실패했습니다. 잠시 후 다시 시도해주세요."); });
    });

    $('#history-list').on('click', 'li', function() {
      const clickedText = $(this).data('text'); // data-text 속성에서 값을 가져옴
      $('#text-input').val(clickedText); // 입력창에 텍스트 채우기
      $('#generate-form').submit(); // form submit 이벤트를 발생시켜 다시 생성
    });

    $('#generate-button').on('click', function(event) {
      const button = $(this);

      // 기존에 있던 ripple span을 제거 (연속 클릭 시)
      button.find('.ripple').remove();

      // 버튼의 가장 긴 변을 기준으로 원의 지름을 계산
      const diameter = Math.max(button.width(), button.height());
      // 버튼 내 클릭한 상대 좌표 계산
      const rect = event.currentTarget.getBoundingClientRect();
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // ripple span 생성 및 스타일 설정
      const ripple = $('<span class="ripple"></span>');
      ripple.css({
        width: diameter,
        height: diameter,
        left: x - (diameter / 2),
        top: y - (diameter / 2)
      });

      // 버튼에 ripple span 추가하여 애니메이션 시작
      button.append(ripple);
    });

    $('#generate-button').on('mousemove', function(event) {
      const button = $(this);
      const rect = event.currentTarget.getBoundingClientRect();

      // 버튼 내에서의 마우스 상대 좌표 계산
      const x = event.clientX - rect.left;
      const y = event.clientY - rect.top;

      // 계산된 좌표를 CSS 변수로 설정
      button.css('--x', x + 'px');
      button.css('--y', y + 'px');
    });

  });
</script>
</body>
</html>
