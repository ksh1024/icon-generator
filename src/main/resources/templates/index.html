<!DOCTYPE html>
<html lang="ko" xmlns:th="http://www.thymeleaf.org">
<head>
  <meta charset="UTF-8">
  <title>wow</title>
  <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
</head>
<body>
<div class="main-wrapper">
  <div class="container">
    <h3>이미지 생성기</h3>
    <p>텍스트를 입력하면 고유한 이미지를 생성합니다.</p>
    <form id="generate-form">
      <input id="text-input" type="text" name="text" placeholder="아무 텍스트나 입력하세요">
      <button id="generate-btn" type="submit">생성하기</button>
    </form>
    <div id="result-area">
      <h4>생성된 이미지</h4>
      <p>입력 텍스트: <b id="result-text"></b></p>
      <img id="result-img" src="" alt="생성된 이미지">
    </div>
    <div id="toast-noti" class="toast"></div>
  </div>
  <div id="history-panel">
    <h3>요청 기록</h3>
    <ol id="history-list"></ol>
  </div>
</div>
</body>
<script>
  let requestHistory = []; // 요청 기록을 저장할 배열
  const MAX_HISTORY_SIZE = 10; // 10개까지 기록

  function showToast(message) {
    const toast = $('#toast-noti');
    toast.text(message);
    toast.addClass('show');

    setTimeout(function() {
      toast.removeClass('show');
    }, 3000);
  }

  // 요청 기록 목록을 화면에 다시 그려주는 함수
  function updateHistoryView() {
    const historyList = $('#history-list');
    historyList.empty(); // 기존 목록을 모두 비움
    requestHistory.forEach(item => {
      // 각 항목을 <li> 태그로 만들어 목록에 추가
      // <li>에 data-text 속성을 추가하여 클릭 시 값을 쉽게 가져올 수 있도록 함
      historyList.append(`<li data-text="${item}">${item}</li>`);
    });
  }

  $(function() {
    $('#generate-form').on('submit', function(event) {
      event.preventDefault();

      const textValue = $('#text-input').val().trim();
      if (textValue === '') {
        $('#text-input').addClass('error').delay(500).queue(function() {
          $(this).removeClass('error').dequeue();
        });
        return;
      }

      const encodedText = encodeURIComponent(textValue);
      const imageUrl = '/generate/' + encodedText;

      $.ajax({
        url: imageUrl,
        method: 'GET',
        xhrFields: {
          responseType: 'blob'
        }
      }).done(function(data) {
        // 받은 blob 데이터를 이미지 URL로 변환 // 브라우저 캐시에 저장됨
        const urlCreator = window.URL;
        const blobUrl = urlCreator.createObjectURL(data);

        $('#result-text').text(textValue);
        $('#result-img').attr('src', blobUrl);
        $('#result-area').fadeIn();

        // 배열의 맨 앞에 새로운 요청을 추가
        requestHistory.unshift(textValue);
        // Set을 이용해 중복된 항목을 제거하고 다시 배열로 만듦
        requestHistory = [...new Set(requestHistory)];
        // 최대 기록 개수 유지
        if (requestHistory.length > MAX_HISTORY_SIZE) {
          requestHistory.pop(); // 가장 오래된 항목 제거
        }
        updateHistoryView();

      }).fail(function(jqXHR, textStatus, errorThrown) {
        console.error("AJAX Error: ", textStatus, errorThrown);
        showToast("이미지 생성에 실패했습니다. 잠시 후 다시 시도해주세요.");
      });
    });

    $('#history-list').on('click', 'li', function() {
      const clickedText = $(this).data('text'); // data-text 속성에서 값을 가져옴
      $('#text-input').val(clickedText); // 입력창에 텍스트 채우기
      $('#generate-form').submit(); // form submit 이벤트를 발생시켜 다시 생성
    });
  });
</script>
<style>
  body { font-family: sans-serif; text-align: center; margin: 0; padding: 20px; }
  .main-wrapper {display: flex;justify-content: center;align-items: flex-start;gap: 20px;max-width: 900px;margin: auto;}
  .container {flex: 2;max-width: 500px;margin: 0;padding: 20px;border: 1px solid #ddd;border-radius: 8px;}
  #history-panel {flex: 1;text-align: left;padding: 20px;border: 1px solid #ddd;border-radius: 8px;height: fit-content;}
  #history-panel h3 { margin-top: 0; text-align: center; }
  #history-list { list-style-type: decimal; padding-left: 20px; margin: 0; }
  #history-list li { margin-bottom: 8px; cursor: pointer; color: #007bff; word-break: break-all; }
  #history-list li:hover { text-decoration: underline; }

  input[type="text"] { width: 70%; padding: 10px; font-size: 16px; }
  button { padding: 10px 20px; font-size: 16px; cursor: pointer; }
  #result-img { margin-top: 30px; border: 2px solid #333; }
  button:hover { background-color: #0056b3; }
  input.error {border-color: #dc3545;animation: shake 0.5s;}
  @keyframes shake { 0%, 100% { transform: translateX(0); } 10%, 30%, 50%, 70%, 90% { transform: translateX(-3px); } 20%, 40%, 60%, 80% { transform: translateX(3px); } }
  #result-area {margin-top: 30px;border: 2px solid #333;padding: 15px;border-radius: 8px;background-color: #f8f9fa;display: none;}
  .toast {visibility: hidden;min-width: 250px;background-color: #dc3545;color: #fff;text-align: center;border-radius: 4px;padding: 16px;position: fixed;z-index: 1;left: 50%;margin-top: 30px;transform: translateX(-50%);opacity: 0;transition: opacity 0.5s, visibility 0.5s;}
  .toast.show {visibility: visible;opacity: 1;}
</style>
</html>
